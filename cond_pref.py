# -*- coding: utf-8 -*-
"""Cond_pref.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1V1-z58rx9uaaXY1-hSkSq55NfnDZoCIY
"""

import streamlit as st
import pandas as pd
import plotly.express as px
from PIL import Image
import gc 


# Affichage de l'image locale
image = Image.open("logo_saham.png")
st.image(image, width=200)

# Titre de l'application
st.title("Dashboard - Conditions PrÃ©fÃ©rentielles des Clients")

# 1. Charger les donnÃ©es
uploaded_file = st.file_uploader("ğŸ“‚ TÃ©lÃ©chargez le fichier Excel", type=["xlsx"])

if uploaded_file:
    try:
        # Lecture directe en mÃ©moire (pas d'enregistrement sur disque)
        df = pd.read_excel(uploaded_file, engine='openpyxl')

        # ğŸ” AperÃ§u sÃ©curisÃ©
        st.subheader("ğŸ“‹ AperÃ§u des donnÃ©es chargÃ©es")
        st.dataframe(df)
    # 2. Vision Client
    st.subheader("ğŸ¯ Vision Client")
    client_id = st.selectbox("SÃ©lectionnez un client", df['code_client'].unique())
    st.write(df[df['code_client'] == client_id])

    # 3. Vision Code OpÃ©ration
    st.subheader("ğŸ”„ Vision par Code OpÃ©ration")
    op_counts = df['code_operation'].value_counts().reset_index()
    op_counts.columns = ['code_operation', 'Nombre de Conditions']
    fig_op = px.bar(op_counts, x='code_operation', y='Nombre de Conditions', title="RÃ©partition par Code OpÃ©ration")
    st.plotly_chart(fig_op)

    # 4. Vision Agence
    st.subheader("ğŸ¢ Vision par Agence")
    agence_counts = df.groupby('code_agence')['code_client'].nunique().reset_index()
    agence_counts.columns = ['Code Agence', 'Nombre de Clients']
    fig_ag = px.bar(agence_counts, x='Code Agence', y='Nombre de Clients', title="Nombre de Clients par Agence")
    st.plotly_chart(fig_ag)

    # 5. Tableau interactif avec filtres
    st.subheader("ğŸ” Filtres dynamiques")
    agence_filtre = st.multiselect("Filtrer par agence", options=df['code_agence'].unique())
    op_filtre = st.multiselect("Filtrer par opÃ©ration", options=df['code_operation'].unique())

    df_filtrÃ© = df.copy()
    if agence_filtre:
        df_filtrÃ© = df_filtrÃ©[df_filtrÃ©['code_agence'].isin(agence_filtre)]
    if op_filtre:
        df_filtrÃ© = df_filtrÃ©[df_filtrÃ©['code_operation'].isin(op_filtre)]

    st.dataframe(df_filtrÃ©)

        # 6. ğŸ” Nettoyage mÃ©moire pour sÃ©curitÃ©
        del df, df_filtrÃ©, op_counts, agence_counts
        gc.collect()

    except Exception as e:
        st.error(f"Erreur lors de la lecture du fichier : {e}")
else:
    st.info("Veuillez charger un fichier Excel pour dÃ©marrer.")


